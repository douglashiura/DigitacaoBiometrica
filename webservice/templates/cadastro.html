<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Cadastro</title>
    <!-- animation -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.2/animate.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <!-- jquery -->
    <script src="cadastro.min.js"></script>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js" type="text/javascript"></script>
  </head>

  <body class="text-center">
  
    <!--==================================================================== FORMULARIO ====================================================================-->
    <div class='form' style="display:block;">
    <form class="form-cadastro">
      <img class="mb-4" src="{{ url_for('static', filename='img/estrutura_incial.png') }}" alt="" width="148" height="148">
      <h1 class="h3 mb-3 font-weight-normal">Cadastre-se</h1>

      <label for="username" class="sr-only">usuario:</label>
      <input type="text" id="username" class="form-control" placeholder="usuario" data-toggle="tooltip" data-placement="top">

      <label for="password" class="sr-only">senha:</label>
      <input type="text" id="password" class="form-control" placeholder="senha" required="">
      <button id="btn_cadastro" type="button" onclick="cadastro()" data-toggle="collapse" aria-expanded="false" class="btn-signup-check btn btn-lg btn-secondary btn-block">Proximo</button>
    </div>
      <div class='user_already_exist' style="display:none; margin-top: 30%; position: absolute; align-items: center;">USUARIO JÁ CADASTRADO</div>

    <!--==================================================================== INPUT DIGITAÇÃO ====================================================================-->
    <div class='typing-form' style="display:none;">
      <h1>Hora de cadastrar seu padrão biometrico, digite o seguinte texto:</h1>
      <div id='text_color' style="color: black; font-style: italic;">
        <h2>"com grandes poderes vem grandes responsabilidades"</h2>
      </div>
      <textarea onfocus="text_onfocus();" onkeydown="digitacao_keydown();" onkeyup="digitacao_keyup();" type="text" class="form-control" id="texto_input" placeholder="Digite aqui..." cols="20" rows="3"></textarea>
      <button id="btn_cadastrar" disabled type="button" onclick="send_biometric()" data-toggle="collapse" aria-expanded="false" class="btn-signup btn btn-lg btn-primary btn-block">cadastrar</button>
    </div>

    <!--==================================================================== Cadastro sucesso ====================================================================-->
    <div class='cadastro_sucesso' style="display:none;">
      <h1>Cadastro Realizado com Sucesso!</h1>
    </div>


<!--==================================================================== SCRIPTS ====================================================================-->
<script type="text/javascript">
  var usuario_id;
  var entrada_dados;
  var digitacao_pattern = [];
  var texto_input;
  var texto_padrao = "com grandes poderes vem grandes responsabilidades";
  const botao_cadastro = document.getElementById("btn_cadastrar");
  const cadastro_sucesso = document.querySelector(".cadastro_sucesso");
  const form = document.querySelector('.form');
  const typing_form = document.querySelector('.typing-form');
  const exist = document.querySelector('.user_already_exist');

  function cadastro(){     
      $.ajax({
          type : 'POST',
          url : 'http://127.0.0.1:3000/usuario',
          contentType: 'application/json; charset=UTF-8',
          data : JSON.stringify({'username':username.value, 'password': password.value}),
          dataType : 'json',
			success: function(rdata){
				if(rdata['cadastro_cod']=='UserRegistrySuccess'){
					usuario_id = rdata['id_usuario']
          console.log(usuario_id) 
          form.style.display = 'none'
          exist.style.display = 'none'
          typing_form.style.display = 'block'
				}
				else if(rdata['cadastro_cod']=='UsernameAlreadyExist'){
          console.log('Username já cadastrado..');
          const exist = document.querySelector('.user_already_exist');
          exist.style.display = 'block'
          			
				}
			}
		});
  }

  function text_onfocus(){
        now_1 = Date.now(); // PEGA HORA 1
        now_2 = Date.now(); // PEGA HORA 2
      }

  function digitacao_keydown(){
        now_3 = Date.now();
        entrada_dados = (now_3 - now_1) / 1000; 
        digitacao_pattern.push(entrada_dados);
        verificaTexto();
      }

  function digitacao_keyup() {
        now_4 = Date.now();
        entrada_dados = (now_4 - now_1) / 1000; 
        digitacao_pattern.push(entrada_dados); 
        verificaTexto()           
      }
  
  function verificaTexto() {
        texto_input = document.getElementById("texto_input").value;
        if (texto_padrao == texto_input){
          document.getElementById("text_color").style.color="#19e030";
          botao_cadastro.disabled = false;
          console.log('digitado corretamente');
        }
        else {
          document.getElementById("text_color").style.color="#de213a";
          botao_cadastro.disabled = true;
          console.log('texto não correto')
        }
      }
  
  function send_biometric(){
      typing_form.style.display = 'none'
      cadastro_sucesso.style.display = 'block'
      $.ajax({
          type : 'POST',
          url : 'http://127.0.0.1:3000/biometria',
          contentType: 'application/json; charset=UTF-8',
          data : JSON.stringify({'user_id':usuario_id, 'data':digitacao_pattern}),
          dataType : 'json',
			success: function(rdata){
				if(rdata['biometric_cod']=='Success'){
					console.log('sucess')
				}
				else if(rdata['biometric_cod']=='Fail'){
          console.log('fail');
				}
			}
		});
    }
    
</script>

    
  </body>
</html>
